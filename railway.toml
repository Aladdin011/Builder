[build]
builder = "NIXPACKS"

[deploy]
healthcheckPath = "/health"
healthcheckTimeout = 300
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

# Backend service
[[services]]
name = "backend"
source = "./backend"

[services.variables]
NODE_ENV = "production"
PORT = "5000"

[services.build]
buildCommand = "npm install && npm run build"
startCommand = "npm start"

# Database service  
[[services]]
name = "database"
source = "postgres:13"

[services.variables]
POSTGRES_DB = "jdmarc_production"
POSTGRES_USER = "jdmarc_user"

# Frontend service
[[services]]
name = "frontend" 
source = "./"

[services.variables]
NODE_ENV = "production"

[services.build]
buildCommand = "npm install && npm run build"
startCommand = "npx serve -s dist -p $PORT"

# Environment variables that need to be set in Railway dashboard:
# JWT_SECRET - Random secure string
# JWT_REFRESH_SECRET - Random secure string  
# DATABASE_URL - Will be auto-generated by Railway for PostgreSQL
# FRONTEND_URL - Your Railway frontend domain
# EMAIL_PROVIDER - gmail/sendgrid/mailgun/ses
# ADMIN_EMAIL - Admin notification email
# SMTP_* - Email configuration based on provider